---
import Layout from '../layouts/Layout.astro';

const GOOGLE_CALENDAR_ID = import.meta.env.PUBLIC_GOOGLE_CALENDAR_ID
  ?? '669bc5c8244754c72baadb665cc21b5c71f3f6d007220664d9f213d4055480d1@group.calendar.google.com';

const CALENDAR_TIMEZONE = import.meta.env.PUBLIC_GOOGLE_CALENDAR_TIMEZONE ?? 'Europe/Rome';
const CALENDAR_HEIGHT = import.meta.env.PUBLIC_GOOGLE_CALENDAR_HEIGHT ?? '800';

const embedParams = new URLSearchParams({
  src: GOOGLE_CALENDAR_ID,
  ctz: CALENDAR_TIMEZONE,
  mode: 'MONTH',
  showTitle: '0',
  showPrint: '0',
  showTabs: '0',
  showCalendars: '0',
  showTz: '0',
  wkst: '2',
  hl: 'en'
});

const embedUrl = `https://calendar.google.com/calendar/embed?${embedParams.toString()}`;
---

<Layout title="Calendar | The Nomad Upupa">
  <section class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-serif font-bold text-gray-900 dark:text-gray-100" data-lang="en">
        Availability calendar
      </h1>
      <h1 class="text-3xl md:text-4xl font-serif font-bold text-gray-900 dark:text-gray-100" data-lang="it" style="display: none;">
        Calendario disponibilità
      </h1>
      <p class="mt-3 text-gray-600 dark:text-gray-300 leading-relaxed" data-lang="en">
        This calendar shows my possible availability for walks, excursions, chats, and video calls.
      </p>
      <p class="mt-3 text-gray-600 dark:text-gray-300 leading-relaxed" data-lang="it" style="display: none;">
        Questo calendario indica la mia possibile disponibilità per passeggiate, escursioni, chiacchierate e videochiamate.
      </p>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400 leading-relaxed" data-lang="en">
        Weekends may be uncertain due to my volunteer activity with hiking guides.
      </p>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-400 leading-relaxed" data-lang="it" style="display: none;">
        I weekend possono essere incerti a causa della mia attività di volontariato con le guide escursionistiche.
      </p>
    </header>

    <div class="rounded-2xl border border-warm-200/70 dark:border-warm-900/50 bg-white/90 dark:bg-zinc-900/90 shadow-sm overflow-hidden">
      <div class="px-5 py-4 border-b border-warm-200/70 dark:border-warm-900/50 bg-warm-50/80 dark:bg-zinc-900 space-y-3">
        <p class="text-sm font-medium text-warm-900 dark:text-warm-200" data-lang="en">Live availability</p>
        <p class="text-sm font-medium text-warm-900 dark:text-warm-200" data-lang="it" style="display: none;">Disponibilità live</p>

        <div class="flex flex-wrap gap-2" role="group" aria-label="Calendar view selector">
          <button type="button" class="calendar-view-btn is-active" data-view="MONTH">
            <span data-lang="en">Month</span>
            <span data-lang="it" style="display: none;">Mese</span>
          </button>
          <button type="button" class="calendar-view-btn" data-view="WEEK" data-range-days="0">
            <span data-lang="en">Week</span>
            <span data-lang="it" style="display: none;">Settimana</span>
          </button>
          <button type="button" class="calendar-view-btn" data-view="AGENDA" data-range-days="1">
            <span data-lang="en">Day timeline</span>
            <span data-lang="it" style="display: none;">Giorno timeline</span>
          </button>
        </div>
      </div>

      <iframe
        id="availability-calendar"
        src={embedUrl}
        class="w-full bg-white transition-[filter] duration-300"
        style={`height: ${CALENDAR_HEIGHT}px; border: 0;`}
        title="Google Calendar availability"
        loading="lazy"
        data-calendar-id={GOOGLE_CALENDAR_ID}
        data-timezone={CALENDAR_TIMEZONE}
        data-view="MONTH"
        data-range-days="0"
      ></iframe>
    </div>

  </section>

  <style>
    /* Google Calendar embed has no native dark mode; emulate to match site theme */
    html.dark #availability-calendar {
      filter: invert(0.93) hue-rotate(180deg) saturate(0.85) contrast(0.95);
    }

    .calendar-view-btn {
      border: 1px solid rgb(227 196 157 / 0.7);
      background-color: rgb(255 255 255 / 0.75);
      color: rgb(120 53 15);
      border-radius: 9999px;
      font-size: 0.875rem;
      line-height: 1.25rem;
      font-weight: 500;
      padding: 0.35rem 0.75rem;
      transition: all 0.2s ease;
    }

    .calendar-view-btn:hover {
      border-color: rgb(217 119 6 / 0.5);
      color: rgb(146 64 14);
    }

    .calendar-view-btn.is-active {
      background-color: rgb(120 53 15);
      border-color: rgb(120 53 15);
      color: rgb(255 255 255);
    }

    html.dark .calendar-view-btn {
      background-color: rgb(39 39 42 / 0.75);
      border-color: rgb(82 82 91);
      color: rgb(254 243 199);
    }

    html.dark .calendar-view-btn:hover {
      border-color: rgb(251 191 36 / 0.55);
      color: rgb(254 215 170);
    }

    html.dark .calendar-view-btn.is-active {
      background-color: rgb(251 191 36);
      border-color: rgb(251 191 36);
      color: rgb(28 25 23);
    }
  </style>

  <script is:inline>
    function calendarLang() {
      const lang = document.documentElement.getAttribute('lang')
        || document.documentElement.getAttribute('data-language')
        || localStorage.getItem('language-preference')
        || 'en';
      return lang.startsWith('it') ? 'it' : 'en';
    }

    function formatDateRange(days) {
      const parsedDays = Number(days || 0);
      if (!Number.isFinite(parsedDays) || parsedDays <= 0) return '';

      const start = new Date();
      const end = new Date(start);
      end.setDate(start.getDate() + parsedDays);

      const toYmd = (value) => `${value.getFullYear()}${String(value.getMonth() + 1).padStart(2, '0')}${String(value.getDate()).padStart(2, '0')}`;
      return `${toYmd(start)}/${toYmd(end)}`;
    }

    function buildEmbedUrl(calendarId, timezone, lang, view, rangeDays) {
      const params = new URLSearchParams({
        src: calendarId,
        ctz: timezone,
        mode: view,
        showTitle: '0',
        showPrint: '0',
        showTabs: '0',
        showCalendars: '0',
        showTz: '0',
        wkst: '2',
        hl: lang
      });

      const dateRange = formatDateRange(rangeDays);
      if (dateRange) {
        params.set('dates', dateRange);
      }

      return `https://calendar.google.com/calendar/embed?${params.toString()}`;
    }

    function syncCalendarLanguage() {
      const iframe = document.getElementById('availability-calendar');
      if (!iframe) return;

      const lang = calendarLang();
      const currentView = iframe.dataset.view || 'MONTH';
      const rangeDays = iframe.dataset.rangeDays || '0';
      const nextSrc = buildEmbedUrl(iframe.dataset.calendarId || '', iframe.dataset.timezone || 'Europe/Rome', lang, currentView, rangeDays);
      if (iframe.getAttribute('src') !== nextSrc) {
        iframe.setAttribute('src', nextSrc);
      }
    }

    function setCalendarView(view, rangeDays = '0') {
      const iframe = document.getElementById('availability-calendar');
      if (!iframe || !view) return;

      iframe.dataset.view = view;
      iframe.dataset.rangeDays = rangeDays;

      document.querySelectorAll('.calendar-view-btn').forEach((button) => {
        const sameView = button.dataset.view === view;
        const sameRange = (button.dataset.rangeDays || '0') === String(rangeDays || '0');
        button.classList.toggle('is-active', sameView && sameRange);
      });

      syncCalendarLanguage();
    }

    document.querySelectorAll('.calendar-view-btn').forEach((button) => {
      button.addEventListener('click', () => {
        setCalendarView(button.dataset.view || 'MONTH', button.dataset.rangeDays || '0');
      });
    });

    syncCalendarLanguage();

    const observer = new MutationObserver(() => syncCalendarLanguage());
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['lang', 'data-language', 'data-initial-lang']
    });

    window.addEventListener('storage', (event) => {
      if (event.key === 'language-preference') {
        syncCalendarLanguage();
      }
    });
  </script>
</Layout>
